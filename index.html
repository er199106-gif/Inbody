<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InBody by ER1991</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- html2canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <!-- jsPDF (Added for PDF Export) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        :root {
            --primary: #00d2ff; /* Medical Cyan */
            --primary-dark: #009ac2;
            --accent: #00e676; /* Success Green */
            --danger: #ff5252;
            --warning: #ffb142;
            --bg-dark: #0f1115;
            --bg-card: #1c1f26;
            --text-light: #ffffff;
            --text-gray: #9ca3af;
            --font-en: 'Inter', sans-serif;
            --font-ar: 'Tajawal', sans-serif;
            --transition: all 0.3s ease;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: var(--font-en);
            background-color: var(--bg-dark);
            color: var(--text-light);
            line-height: 1.6;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
        }

        body.rtl {
            direction: rtl;
            font-family: var(--font-ar);
        }

        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        .hidden { display: none !important; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .text-center { text-align: center; }
        .mb-4 { margin-bottom: 1rem; }
        .mt-4 { margin-top: 1rem; }

        /* Buttons */
        .btn {
            padding: 12px 28px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: #000;
            box-shadow: 0 4px 15px rgba(0, 210, 255, 0.3);
        }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0, 210, 255, 0.4); }
        .btn-outline {
            background: transparent;
            border: 2px solid var(--primary);
            color: var(--primary);
        }
        .btn-outline:hover { background: rgba(0, 210, 255, 0.1); }

        /* Splash Screen */
        #splash-screen {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg-dark);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            animation: fadeOut 0.5s ease-out 2.5s forwards;
            pointer-events: none;
        }
        .splash-logo {
            font-size: 2.5rem;
            font-weight: 800;
            letter-spacing: 2px;
            background: linear-gradient(to right, var(--primary), #fff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: scaleUp 1.5s ease-in-out infinite alternate;
        }
        .splash-sub { color: var(--text-gray); margin-top: 10px; font-size: 0.9rem; letter-spacing: 1px; }

        @keyframes scaleUp { from { transform: scale(0.95); opacity: 0.8; } to { transform: scale(1.05); opacity: 1; } }
        @keyframes fadeOut { to { opacity: 0; visibility: hidden; } }

        /* Nav */
        nav { display: flex; justify-content: space-between; align-items: center; padding: 20px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .app-logo { font-size: 1.4rem; font-weight: 700; color: var(--primary); letter-spacing: -1px; }
        .lang-switch { cursor: pointer; font-weight: 600; color: var(--text-gray); transition: color 0.3s; }
        .lang-switch:hover { color: var(--text-light); }

        /* Screens */
        .screen { min-height: 85vh; padding: 40px 0; display: flex; flex-direction: column; justify-content: center; animation: fadeIn 0.6s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        /* Landing */
        .hero-title { font-size: 3rem; font-weight: 800; margin-bottom: 20px; line-height: 1.2; }
        .hero-desc { font-size: 1.1rem; color: var(--text-gray); margin-bottom: 40px; max-width: 700px; margin-left: auto; margin-right: auto; }
        .features-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-top: 50px; }
        .feature-card { background: var(--bg-card); padding: 30px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.05); transition: var(--transition); }
        .feature-card:hover { transform: translateY(-5px); border-color: var(--primary); }
        .feature-icon { font-size: 2rem; color: var(--primary); margin-bottom: 15px; }

        /* Form */
        .form-container { background: var(--bg-card); padding: 40px; border-radius: 16px; max-width: 550px; margin: 0 auto; width: 100%; border: 1px solid rgba(255,255,255,0.05); }
        .progress-bar { height: 4px; background: rgba(255,255,255,0.1); margin-bottom: 30px; border-radius: 2px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--primary); width: 33%; transition: width 0.3s ease; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; color: var(--text-gray); font-size: 0.9rem; font-weight: 500; }
        input { width: 100%; padding: 12px 15px; background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: white; font-size: 1rem; outline: none; transition: border 0.3s; }
        input:focus { border-color: var(--primary); }
        .radio-group { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; }
        .radio-card { background: rgba(255,255,255,0.03); padding: 15px; border-radius: 8px; cursor: pointer; text-align: center; border: 1px solid transparent; transition: var(--transition); }
        .radio-card:hover { background: rgba(255,255,255,0.08); }
        .radio-card.selected { background: rgba(0, 210, 255, 0.15); border-color: var(--primary); color: var(--primary); }

        /* Results */
        .dashboard-header { margin-bottom: 30px; display: flex; justify-content: space-between; align-items: flex-end; flex-wrap: wrap; gap: 20px; }
        .goal-badge { background: var(--accent); color: #000; padding: 5px 15px; border-radius: 20px; font-weight: 700; font-size: 0.9rem; }
        
        .warning-box {
            background: rgba(255, 177, 66, 0.15);
            border-left: 4px solid var(--warning);
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            display: flex;
            align-items: start;
            gap: 12px;
        }
        body.rtl .warning-box { border-left: none; border-right: 4px solid var(--warning); }

        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 40px; }
        .metric-card { background: var(--bg-card); padding: 25px; border-radius: 12px; position: relative; overflow: hidden; }
        .metric-card::before { content:''; position: absolute; top:0; left:0; width: 4px; height: 100%; background: var(--primary); opacity: 0.5; }
        body.rtl .metric-card::before { left: auto; right: 0; }
        .metric-value { font-size: 2.2rem; font-weight: 700; margin: 10px 0; color: var(--text-light); }
        .metric-label { color: var(--text-gray); font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px; }
        .metric-sub { font-size: 0.85rem; color: var(--text-gray); margin-top: 5px; }

        /* Macros Container (New) */
        .macros-container {
            background: rgba(255,255,255,0.05);
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 40px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .macro-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .macro-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text-light);
        }

        .charts-container { background: var(--bg-card); padding: 25px; border-radius: 12px; margin-bottom: 40px; }
        .chart-wrapper { height: 300px; width: 100%; position: relative; }

        #report-capture-area {
            background: white;
            color: #1a1a1a;
            font-family: 'Inter', sans-serif;
            padding: 40px;
            width: 100%;
            max-width: 900px;
            margin: 0 auto 30px;
            border-radius: 4px;
            text-align: left;
            position: relative;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
            min-height: 500px;
        }
        #report-capture-area.rtl-report { direction: rtl; font-family: 'Tajawal', sans-serif; text-align: right; }
        .report-header { text-align: center; border-bottom: 2px solid #eee; padding-bottom: 20px; margin-bottom: 25px; }
        .report-logo { font-size: 1.8rem; font-weight: 800; color: #00d2ff; letter-spacing: -1px; }
        .report-section-title { 
            background: #f4f8fb; color: #006ba6; font-weight: 700; padding: 6px 12px; margin-top: 20px; margin-bottom: 12px; border-radius: 4px; display: inline-block; font-size: 14px; 
        }
        .report-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .report-row { display: flex; justify-content: space-between; border-bottom: 1px dashed #e0e0e0; padding-bottom: 4px; font-size: 14px; color: #444; }
        .report-val { font-weight: 600; color: #000; }
        .report-full { display: grid; grid-template-columns: 1fr; gap: 8px; }
        .report-full .report-row { border-bottom: 1px solid #eee; }

        #generated-image-container {
            margin-top: 30px;
            padding: 20px;
            background: var(--bg-card);
            border-radius: 12px;
            text-align: center;
            border: 1px solid var(--primary);
        }
        #generated-image-container img {
            max-width: 100%;
            height: auto;
            border-radius: 4px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        footer { text-align: center; padding: 40px 0; border-top: 1px solid rgba(255,255,255,0.05); color: var(--text-gray); font-size: 0.85rem; }

        @media (max-width: 768px) {
            .hero-title { font-size: 2rem; }
            .dashboard-grid { grid-template-columns: 1fr; }
            #report-capture-area { padding: 20px; }
            .report-grid { grid-template-columns: 1fr; }
            .report-row { font-size: 13px; }
            .macros-container .flex { flex-wrap: wrap; gap: 20px; }
        }
    </style>
</head>
<body>

    <div id="splash-screen">
        <div class="splash-logo">INBODY BY ER1991</div>
        <div class="splash-sub">Advanced Body Composition Analysis</div>
    </div>

    <div class="container">
        <!-- Nav -->
        <nav>
            <div class="app-logo">INBODY <span style="color:#fff">BY ER1991</span></div>
            <div class="lang-switch" onclick="toggleLanguage()" id="langBtn">العربية</div>
        </nav>

        <!-- 1. Landing -->
        <div id="landing-page" class="screen">
            <div class="text-center">
                <h1 class="hero-title" data-i18n="heroTitle">Advanced Body Composition Analysis</h1>
                <p class="hero-desc" data-i18n="heroDesc">Analysis based on the latest equations and approved scientific foundations for evaluating body composition, providing accurate indicators to support health and nutritional decisions.</p>
                <button class="btn btn-primary" onclick="goToScreen('form-page')" data-i18n="startTest">Start Analysis <i class="fas fa-chevron-right"></i></button>
                <div class="features-grid">
                    <div class="feature-card">
                        <i class="fas fa-microscope feature-icon"></i>
                        <h3 data-i18n="feat1">Verified Scientific Accuracy</h3>
                        <p data-i18n="feat1Desc">Relies on modern scientific equations used in body composition analysis devices.</p>
                    </div>
                    <div class="feature-card">
                        <i class="fas fa-brain feature-icon"></i>
                        <h3 data-i18n="feat2">Smart Logic</h3>
                        <p data-i18n="feat2Desc">Dynamic interpretation of body composition.</p>
                    </div>
                    <div class="feature-card">
                        <i class="fas fa-file-medical-alt feature-icon"></i>
                        <h3 data-i18n="feat3">Medical Report</h3>
                        <p data-i18n="feat3Desc">Downloadable professional report.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 2. Form -->
        <div id="form-page" class="screen hidden">
            <div class="form-container">
                <div class="progress-bar"><div class="progress-fill" id="progress-fill"></div></div>
                <h3 class="text-center mb-4" id="step-indicator" style="color:var(--primary)">Step 1 of 3</h3>
                <form id="inbody-form" onsubmit="return false;">
                    <div id="step-1" class="wizard-step">
                        <div class="form-group">
                            <label data-i18n="labelName">Full Name</label>
                            <input type="text" id="name" placeholder="e.g. John Doe">
                            <div class="error-msg text-danger" style="color:var(--danger); font-size:0.8rem; display:none; margin-top:5px" id="err-name">Name required</div>
                        </div>
                        <div class="form-group">
                            <label data-i18n="labelPhone">Phone Number</label>
                            <input type="tel" id="phone" placeholder="e.g. +1 234 567 890">
                        </div>
                        <div class="form-group">
                            <label data-i18n="labelGender">Gender</label>
                            <div class="radio-group">
                                <div class="radio-card" onclick="selectRadio('gender', 'Male', this)"><i class="fas fa-male"></i> <span data-i18n="male">Male</span></div>
                                <div class="radio-card" onclick="selectRadio('gender', 'Female', this)"><i class="fas fa-female"></i> <span data-i18n="female">Female</span></div>
                            </div>
                            <input type="hidden" id="gender">
                            <div class="error-msg text-danger" style="color:var(--danger); font-size:0.8rem; display:none; margin-top:5px" id="err-gender">Select Gender</div>
                        </div>
                        <button class="btn btn-primary" style="width:100%" onclick="nextStep(1)" data-i18n="next">Next</button>
                    </div>

                    <div id="step-2" class="wizard-step hidden">
                        <div class="form-group">
                            <label data-i18n="labelDob">Date of Birth</label>
                            <input type="date" id="birth_date">
                            <div class="error-msg text-danger" style="color:var(--danger); font-size:0.8rem; display:none" id="err-dob">Valid date required</div>
                        </div>
                        <div class="flex gap-4" style="gap:15px">
                            <div class="form-group" style="flex:1">
                                <label data-i18n="labelHeight">Height (cm)</label>
                                <input type="number" id="height" placeholder="175">
                                <div class="error-msg text-danger" style="color:var(--danger); font-size:0.8rem; display:none" id="err-height">Required</div>
                            </div>
                            <div class="form-group" style="flex:1">
                                <label data-i18n="labelWeight">Weight (kg)</label>
                                <input type="number" id="weight" placeholder="75">
                                <div class="error-msg text-danger" style="color:var(--danger); font-size:0.8rem; display:none" id="err-weight">Required</div>
                            </div>
                        </div>
                        <div class="flex" style="gap:10px">
                            <button class="btn btn-outline" style="flex:1" onclick="prevStep(2)" data-i18n="back">Back</button>
                            <button class="btn btn-primary" style="flex:1" onclick="nextStep(2)" data-i18n="next">Next</button>
                        </div>
                    </div>

                    <div id="step-3" class="wizard-step hidden">
                        <label data-i18n="labelActivity" class="mb-4">Activity Level</label>
                        <div class="radio-group" style="grid-template-columns: 1fr;">
                            <div class="radio-card" onclick="selectRadio('activity', 'Low (No activity)', this)"><i class="fas fa-couch"></i> <span data-i18n="actLow">Low (Sedentary)</span></div>
                            <div class="radio-card" onclick="selectRadio('activity', 'Light (1-3 workouts/week)', this)"><i class="fas fa-walking"></i> <span data-i18n="actLight">Light (1-3 workouts/week)</span></div>
                            <div class="radio-card" onclick="selectRadio('activity', 'Moderate (3-5 workouts/week)', this)"><i class="fas fa-running"></i> <span data-i18n="actMod">Moderate (3-5 workouts/week)</span></div>
                            <div class="radio-card" onclick="selectRadio('activity', 'High (Daily exercise)', this)"><i class="fas fa-dumbbell"></i> <span data-i18n="actHigh">High (Daily exercise)</span></div>
                            <div class="radio-card" onclick="selectRadio('activity', 'Very High (Intense daily exercise)', this)"><i class="fas fa-fire"></i> <span data-i18n="actVHigh">Very High (Athlete)</span></div>
                        </div>
                        <input type="hidden" id="activity_level">
                        <div class="error-msg text-danger" style="color:var(--danger); font-size:0.8rem; display:none; margin-top:10px" id="err-activity">Select Activity</div>
                        <br>
                        <div class="flex" style="gap:10px">
                            <button class="btn btn-outline" style="flex:1" onclick="prevStep(3)" data-i18n="back">Back</button>
                            <button class="btn btn-primary" style="flex:1" onclick="submitForm()" data-i18n="analyze">Analyze Body</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- 3. Loading -->
        <div id="loading-page" class="screen hidden text-center">
            <i class="fas fa-circle-notch fa-spin fa-3x text-primary mb-4"></i>
            <h2 data-i18n="analyzing">Processing Analysis...</h2>
            <p style="color:var(--text-gray)" id="loading-subtext">Calculating BMR, Visceral Fat Estimate & Macros</p>
        </div>

        <!-- 4. Results -->
        <div id="results-page" class="screen hidden">
            <div class="dashboard-header">
                <div>
                    <h2 style="margin-bottom:5px" data-i18n="resultsTitle">Your Analysis Results</h2>
                    <div class="text-gray" id="res-name-display"></div>
                </div>
                <div class="goal-badge" id="res-goal-badge">MAINTENANCE</div>
            </div>

            <div id="warnings-container"></div>

            <div class="dashboard-grid">
                <div class="metric-card">
                    <div class="metric-label">BMI</div>
                    <div class="metric-value" id="res-bmi">--</div>
                    <div class="metric-sub text-primary" id="res-body-type">--</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label" data-i18n="bodyFat">Body Fat %</div>
                    <div class="metric-value" id="res-fat">--</div>
                    <div class="metric-sub" id="res-fat-mass">-- kg Fat Mass</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label" data-i18n="muscle">Muscle Mass</div>
                    <div class="metric-value" id="res-muscle">--</div>
                    <div class="metric-sub" id="res-sk-muscle">-- kg Skeletal</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label" data-i18n="calories">Daily Energy</div>
                    <div class="metric-value" id="res-calories">--</div>
                    <div class="metric-sub" id="res-adj-cal">Adjusted: --</div>
                </div>
                
                <!-- New Card: Metabolic Age -->
                <div class="metric-card" style="border-bottom: 4px solid var(--accent);">
                    <div class="metric-label">Metabolic Age / العمر الأيضي</div>
                    <div class="metric-value" id="res-metabolic-age">--</div>
                    <div class="metric-sub" style="color: var(--accent)">Physiological Estimate</div>
                </div>
                
                <!-- New Card: Visceral Fat -->
                <div class="metric-card" style="border-bottom: 4px solid var(--danger);">
                    <div class="metric-label">Visceral Fat / الدهون الحشوية</div>
                    <div class="metric-value" id="res-vfat">--</div>
                    <div class="metric-sub">Range: 1-9 Normal</div>
                </div>
            </div>

            <div class="dashboard-grid" style="grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));">
                <div class="metric-card" style="padding:15px">
                    <div class="metric-label">Water</div>
                    <div class="metric-value" style="font-size:1.5rem" id="res-water">--</div>
                </div>
                <div class="metric-card" style="padding:15px">
                    <div class="metric-label">Protein Mass</div>
                    <div class="metric-value" style="font-size:1.5rem" id="res-protein-mass">--</div>
                </div>
                <div class="metric-card" style="padding:15px">
                    <div class="metric-label">Minerals</div>
                    <div class="metric-value" style="font-size:1.5rem" id="res-minerals">--</div>
                </div>
                <div class="metric-card" style="padding:15px">
                    <div class="metric-label">Fat Burn HR</div>
                    <div class="metric-value" style="font-size:1.5rem" id="res-hr-zone">--</div>
                </div>
                <div class="metric-card" style="padding:15px">
                    <div class="metric-label">Ideal Weight</div>
                    <div class="metric-value" style="font-size:1.5rem" id="res-ideal-weight">--</div>
                </div>
            </div>

            <!-- New Section: Macros -->
            <div class="macros-container mt-4">
                <h4 class="text-center mb-4">Daily Macros / الاحتياج اليومي من المغذيات</h4>
                <div class="flex justify-between text-center">
                    <div class="macro-item"><div id="macro-p" class="macro-value text-primary">--</div><small>Protein (g)</small></div>
                    <div class="macro-item"><div id="macro-c" class="macro-value text-warning">--</div><small>Carbs (g)</small></div>
                    <div class="macro-item"><div id="macro-f" class="macro-value" style="color:var(--danger)">--</div><small>Fats (g)</small></div>
                </div>
            </div>

            <div class="charts-container">
                <h3 class="mb-4" data-i18n="compositionTitle">Body Composition Analysis</h3>
                <div class="chart-wrapper">
                    <canvas id="compositionChart"></canvas>
                </div>
            </div>

            <div class="mb-4">
                <h3 class="mb-4" data-i18n="yourPlan">Recommended Nutrition Strategy</h3>
                <div id="diet-container"></div>
            </div>

            <div class="text-center mt-4" style="background:var(--bg-card); padding:30px; border-radius:12px">
                <h3 class="mb-4" data-i18n="reportPreview">Professional Report</h3>
                <div id="report-capture-area"></div>
                
                <div class="flex justify-center" style="gap:15px; margin-top:20px; flex-wrap: wrap;">
                    <button class="btn btn-primary" onclick="downloadReport()">
                        <i class="fas fa-download"></i> <span data-i18n="downloadBtn">Download Image</span>
                    </button>
                    <button class="btn btn-outline" onclick="downloadPDF()">
                        <i class="fas fa-file-pdf"></i> <span>Download PDF</span>
                    </button>
                    <button class="btn btn-outline" onclick="location.reload()">
                        <i class="fas fa-redo"></i> <span data-i18n="retest">New Analysis</span>
                    </button>
                </div>

                <div id="generated-image-container" class="hidden"></div>
            </div>
        </div>

        <footer>
            <p>© ER1991 2026 – InBody Analysis System. All Rights Reserved.</p>
        </footer>
    </div>

    <script>
        const i18n = {
            en: {
                heroTitle: "Advanced Body Composition Analysis",
                heroDesc: "Analysis based on the latest equations and approved scientific foundations.",
                startTest: "Start Analysis", feat1: "Accuracy", feat1Desc: "Relies on modern scientific equations.",
                feat2: "Smart Logic", feat2Desc: "Dynamic interpretation of body composition.", feat3: "Medical Report", feat3Desc: "Downloadable professional report.",
                labelName: "Full Name", labelPhone: "Phone Number", labelGender: "Gender", male: "Male", female: "Female",
                labelDob: "Date of Birth", labelHeight: "Height (cm)", labelWeight: "Weight (kg)", labelActivity: "Activity Level",
                actLow: "Low (Sedentary)", actLight: "Light", actMod: "Moderate", actHigh: "High (Daily)", actVHigh: "Athlete",
                analyze: "Analyze Body", back: "Back", next: "Next",
                analyzing: "Processing Analysis...", bodyFat: "Body Fat %", muscle: "Muscle Mass", calories: "Daily Energy",
                compositionTitle: "Body Composition Analysis", yourPlan: "Recommended Nutrition Strategy", reportPreview: "Professional Report",
                downloadBtn: "Download Image", retest: "New Analysis", resultsTitle: "Your Analysis Results",
                gGain: "Weight Gain Toward Ideal Range", gMuscle: "Muscle Building", gRecomp: "Recomposition", gLoss: "Fat Loss", gMaint: "Maintenance",
                wLowFat: "Warning: Body Fat Percentage is extremely low.", wLowMuscle: "Notice: Muscle mass is below average.", wObese: "Alert: BMI indicates Obesity."
            },
            ar: {
                heroTitle: "تحليل متقدم لتركيبة الجسم",
                heroDesc: "التحليل مبني على أحدث المعادلات والأسس العلمية المعتمدة.",
                startTest: "ابدأ التحليل", feat1: "دقة علمية", feat1Desc: "يعتمد على معادلات علمية حديثة.",
                feat2: "منطق ذكي", feat2Desc: "تفسير ديناميكي لتركيبة الجسم.", feat3: "تقرير طبي", feat3Desc: "تقرير احترافي قابل للتحميل.",
                labelName: "الاسم الكامل", labelPhone: "رقم الهاتف", labelGender: "الجنس", male: "ذكر", female: "أنثى",
                labelDob: "تاريخ الميلاد", labelHeight: "الطول (سم)", labelWeight: "الوزن (كجم)", labelActivity: "مستوى النشاط",
                actLow: "منخفض (خامل)", actLight: "خفيف", actMod: "متوسط", actHigh: "عالي (يومي)", actVHigh: "رياضي",
                analyze: "حلل الجسم", back: "سابق", next: "التالي",
                analyzing: "جاري معالجة التحليل...", bodyFat: "نسبة الدهون %", muscle: "كتلة العضلات", calories: "الطاقة اليومية",
                compositionTitle: "تحليل تركيبة الجسم", yourPlan: "استراتيجية التغذية الموصى بها", reportPreview: "التقرير الاحترافي",
                downloadBtn: "تحميل صورة", retest: "تحليل جديد", resultsTitle: "نتائج تحليلك",
                gGain: "زيادة الوزن", gMuscle: "بناء العضلات", gRecomp: "إعادة تكوين", gLoss: "خسارة الدهون", gMaint: "الحفاظ على الوزن",
                wLowFat: "تنبيه: نسبة الدهون منخفضة جداً.", wLowMuscle: "ملاحظة: كتلة العضلات أقل من المعدل.", wObese: "تحذير: مؤشر الكتلة يشير إلى السمنة."
            }
        };

        const dietLibrary = {
            "Low Carb Diet": { en: "A diet low in carbohydrates, focusing on protein and healthy fats.", ar: "نظام غذائي منخفض الكربوهيدرات، يركز على البروتين والدهون الصحية." },
            "Mediterranean Diet": { en: "A diet rich in fruits, vegetables, olive oil, and lean protein.", ar: "نظام غذائي غني بالفواكه والخضروات وزيت الزيتون." },
            "Keto Diet": { en: "A high-fat, low-carb diet that puts body in ketosis.", ar: "نظام غذائي عالي الدهون ومنخفض الكربوهيدرات." },
            "Plant-Based Diet": { en: "A diet focusing on plant foods, avoiding animal products.", ar: "نظام غذائي نباتي." },
            "Paleo Diet": { en: "A diet based on what early humans ate.", ar: "نظام غذائي يعتمد على أكل البشر القدامى." },
            "Intermittent Fasting": { en: "Cycles of eating and fasting.", ar: "دورات من الأكل والصيام." },
            "DASH Diet": { en: "Dietary Approaches to Stop Hypertension.", ar: "النهج الغذائي لوقف ارتفاع ضغط الدم." },
            "Vegan Diet": { en: "A strict plant-based diet.", ar: "نظام غذائي نباتي صارم." },
            "Zone Diet": { en: "A diet balancing 40% carbs, 30% protein, and 30% fat.", ar: "نظام غذائي يوازن 40/30/30." },
            "High Protein Diet": { en: "A diet rich in protein.", ar: "نظام غذائي غني بالبروتين." },
            "Gluten-Free Diet": { en: "A diet avoiding gluten.", ar: "نظام غذائي خالٍ من الغلوتين." },
            "Nordic Diet": { en: "A diet inspired by Nordic cuisine.", ar: "نظام غذائي مستوحى من المطبخ الإسكندنافي." },
            "Flexitarian Diet": { en: "A semi-vegetarian diet.", ar: "نظام غذائي شبه نباتي." },
            "Whole30 Diet": { en: "A 30-day diet eliminating processed foods.", ar: "نظام غذائي لمدة 30 يوماً." },
            "Mind Diet": { en: "A diet focusing on brain health.", ar: "نظام غذائي يركز على صحة الدماغ." },
            "Low FODMAP Diet": { en: "A diet limiting fermentable carbohydrates.", ar: "نظام غذائي محدد للكربوهيدرات المخمرة." },
            "Pescatarian Diet": { en: "A diet including fish.", ar: "نظام غذائي يشمل الأسماك." },
            "Raw Food Diet": { en: "A diet focusing on uncooked foods.", ar: "نظام غذائي يعتمد على الأطعمة غير المطبوخة." },
            "Anti-Inflammatory Diet": { en: "A diet rich in foods that reduce inflammation.", ar: "نظام غذائي غني بالأطعمة المضادة للالتهابات." },
            "Detox Diet": { en: "A short-term diet focused on eliminating toxins.", ar: "نظام غذائي قصير المدى للتخلص من السموم." },
            "Balanced Diet": { en: "A balanced diet.", ar: "نظام غذائي متوازن." },
            "Low Cholesterol Diet": { en: "A diet aimed at reducing cholesterol.", ar: "نظام غذائي لخفض الكوليسترول." },
            "Calorie Deficit Diet": { en: "A diet for weight loss.", ar: "نظام غذائي لفقدان الوزن." },
            "High Fiber Diet": { en: "A diet rich in fiber.", ar: "نظام غذائي غني بالألياف." },
            "Sustainable Diet": { en: "A diet emphasizing environmentally friendly foods.", ar: "نظام غذائي يركز على الأطعمة الصديقة للبيئة." }
        };

        let currentLang = 'en';
        let calculationData = null;
        let chartInstance = null;

        function toggleLanguage() {
            currentLang = currentLang === 'en' ? 'ar' : 'en';
            document.body.classList.toggle('rtl');
            document.getElementById('langBtn').innerText = currentLang === 'en' ? 'العربية' : 'English';
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (i18n[currentLang][key]) el.innerText = i18n[currentLang][key];
            });
            if (calculationData) {
                renderReportPreview(calculationData);
                renderDashboard(calculationData);
            }
        }

        function goToScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
            window.scrollTo(0,0);
        }

        function selectRadio(group, val, el) {
            document.getElementById(group === 'gender' || group === 'activity' ? (group === 'gender' ? 'gender' : 'activity_level') : group).value = val;
            el.parentElement.querySelectorAll('.radio-card').forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');
        }

        function nextStep(curr) {
            if(!validateStep(curr)) return;
            document.getElementById(`step-${curr}`).classList.add('hidden');
            document.getElementById(`step-${curr+1}`).classList.remove('hidden');
            document.getElementById('progress-fill').style.width = `${(curr+1)*33}%`;
            document.getElementById('step-indicator').innerText = currentLang==='en' ? `Step ${curr+1} of 3` : `الخطوة ${curr+1} من 3`;
        }

        function prevStep(curr) {
            document.getElementById(`step-${curr}`).classList.add('hidden');
            document.getElementById(`step-${curr-1}`).classList.remove('hidden');
            document.getElementById('progress-fill').style.width = `${(curr-1)*33}%`;
            document.getElementById('step-indicator').innerText = currentLang==='en' ? `Step ${curr-1} of 3` : `الخطوة ${curr-1} من 3`;
        }

        function validateStep(step) {
            let valid = true;
            if(step===1) {
                if(!document.getElementById('name').value) { valid=false; document.getElementById('err-name').style.display='block'; } else document.getElementById('err-name').style.display='none';
                if(!document.getElementById('gender').value) { valid=false; document.getElementById('err-gender').style.display='block'; } else document.getElementById('err-gender').style.display='none';
            }
            if(step===2) {
                if(!document.getElementById('birth_date').value) { valid=false; document.getElementById('err-dob').style.display='block'; } else document.getElementById('err-dob').style.display='none';
                if(!document.getElementById('height').value) { valid=false; document.getElementById('err-height').style.display='block'; } else document.getElementById('err-height').style.display='none';
                if(!document.getElementById('weight').value) { valid=false; document.getElementById('err-weight').style.display='block'; } else document.getElementById('err-weight').style.display='none';
            }
            if(step===3) {
                if(!document.getElementById('activity_level').value) { valid=false; document.getElementById('err-activity').style.display='block'; } else document.getElementById('err-activity').style.display='none';
            }
            return valid;
        }

        function submitForm() {
            if(!validateStep(3)) return;
            goToScreen('loading-page');
            setTimeout(calculateAndShowResults, 1500);
        }

        // --- NEW: Macros Calculation ---
        function calculateMacros(totalCalories, dietType) {
            let proteinPct, carbPct, fatPct;

            if (dietType.includes("Keto")) {
                proteinPct = 0.25; carbPct = 0.05; fatPct = 0.70;
            } else if (dietType.includes("High Protein") || dietType.includes("Paleo")) {
                proteinPct = 0.35; carbPct = 0.35; fatPct = 0.30;
            } else if (dietType.includes("Low Carb")) {
                proteinPct = 0.30; carbPct = 0.20; fatPct = 0.50;
            } else {
                // Balanced Diet (Default)
                proteinPct = 0.20; carbPct = 0.50; fatPct = 0.30;
            }

            return {
                protein: Math.round((totalCalories * proteinPct) / 4),
                carbs: Math.round((totalCalories * carbPct) / 4),
                fats: Math.round((totalCalories * fatPct) / 9)
            };
        }

        // --- NEW: Save History ---
        function saveToHistory(res, name) {
            try {
                let history = JSON.parse(localStorage.getItem('inbody_history') || '[]');
                const record = {
                    date: new Date().toLocaleDateString(),
                    name: name,
                    weight: res.weight,
                    bmi: res.bmi,
                    fat: res.fatPercentage,
                    metabolicAge: res.metabolicAge,
                    vFat: res.vFat
                };
                history.unshift(record); // Add to top
                if (history.length > 5) history.pop(); // Keep last 5
                localStorage.setItem('inbody_history', JSON.stringify(history));
                console.log("History saved:", record);
            } catch(e) {
                console.warn("LocalStorage not available", e);
            }
        }

        // --- UPDATED: calculateResults logic (Integrating User's Request) ---
        function calculateAndShowResults() {
            // Inputs
            const name = document.getElementById('name').value;
            const phone = document.getElementById('phone').value;
            const gender = document.getElementById('gender').value;
            const birthDate = new Date(document.getElementById('birth_date').value);
            const height = parseFloat(document.getElementById('height').value);
            const weight = parseFloat(document.getElementById('weight').value);
            const activityLevel = document.getElementById('activity_level').value;

            // 1. Age
            const today = new Date();
            let age = today.getFullYear() - birthDate.getFullYear();
            if (today.getMonth() < birthDate.getMonth() || (today.getMonth() === birthDate.getMonth() && today.getDate() < birthDate.getDate())) age--;

            // 2. BMI & HeightM
            const heightM = height / 100;
            const bmi = weight / (heightM * heightM);

            // --- UPDATE 1: BMR (Mifflin-St Jeor) ---
            let bmr = (10 * weight) + (6.25 * height) - (5 * age);
            bmr = (gender === 'Male') ? bmr + 5 : bmr - 161;

            // --- UPDATE 2: TDEE ---
            const activityMultipliers = {
                'Low (No activity)': 1.2,
                'Light (1-3 workouts/week)': 1.375,
                'Moderate (3-5 workouts/week)': 1.55,
                'High (Daily exercise)': 1.725,
                'Very High (Intense daily exercise)': 1.9
            };
            const tdee = Math.round(bmr * activityMultipliers[activityLevel]);

            // --- UPDATE 3: Fat Percentage (Deurenberg) ---
            const genderFactor = (gender === 'Male') ? 1 : 0;
            let fatPercentage = (1.20 * bmi) + (0.23 * age) - (10.8 * genderFactor) - 5.4;
            
            // Validation for display (keep it reasonable)
            if (gender === 'Male' && fatPercentage < 3) fatPercentage = 3;
            if (gender === 'Female' && fatPercentage < 8) fatPercentage = 8;

            const fat_mass = weight * (fatPercentage / 100);

            // --- UPDATE 4: Visceral Fat (Estimate) ---
            let vFat = (0.5 * bmi) + (0.1 * age) - (gender === 'Male' ? 5.8 : 4.4);
            vFat = Math.max(1, Math.min(20, Math.round(vFat))); // Range 1 to 20

            // --- UPDATE 5: Metabolic Age ---
            let metabolicAge = age;
            const idealBmr = (10 * weight) + (6.25 * height) - (5 * age);
            const diff = ((bmr - idealBmr) / idealBmr) * 100;
            metabolicAge = Math.round(age - (diff * 0.5));

            // --- Existing Logic: Muscle & Water (Preserved) ---
            let muscle_mass, skeletal_muscle_mass, minerals_mass, water_mass;
            if(gender==="Male") {
                muscle_mass = (0.566 * weight) + (0.143 * height) - (0.191 * age) - 17.8;
                skeletal_muscle_mass = muscle_mass * 0.52;
                minerals_mass = weight * 0.05;
                water_mass = weight * 0.6;
            } else {
                muscle_mass = (0.407 * weight) + (0.267 * height) - (0.098 * age) - 14.6;
                skeletal_muscle_mass = muscle_mass * 0.46;
                minerals_mass = weight * 0.045;
                water_mass = weight * 0.5;
            }

            const protein_mass = 20 * (muscle_mass / weight);

            // --- UPDATE: Macros Calculation ---
            // Determine diet type for macros based on diet_plan_1
            let dietType = "Default"; 
            // We need to calculate diet plans first to know which type to use, or use a simple heuristic
            // For simplicity, we will map Diet Name to Keyword after calculating diets below.
            // But let's pre-calculate simple macros based on goal if needed? 
            // No, the user wants calculateMacros function called. We will call it in render step or here.
            
            // Other calcs (Python Logic Preservation)
            const activity_carb_ratios = {
                "Low (No activity)": 0.45, "Light (1-3 workouts/week)": 0.50,
                "Moderate (3-5 workouts/week)": 0.55, "High (Daily exercise)": 0.60,
                "Very High (Intense daily exercise)": 0.65
            };
            const carb_ratio = activity_carb_ratios[activityLevel];
            const carb_mass = (tdee * carb_ratio) / 4;
            const calcium = minerals_mass * 0.35;
            const iron = minerals_mass * 0.05;
            const magnesium = minerals_mass * 0.15;
            const ideal_weight = 22.5 * Math.pow(height / 100, 2);
            const ideal_weight_range = [18.5 * Math.pow(height / 100, 2), 24.9 * Math.pow(height / 100, 2)];
            const hr_max = 208 - age;
            const fat_burning_zone_min = hr_max * 0.60;
            const fat_burning_zone_max = hr_max * 0.70;

            // --- Diet Selection (Python Logic) ---
            let diet_plan_1, diet_plan_2;
            let muscle_mass_pct = (muscle_mass / weight) * 100;

            if (bmi > 35) diet_plan_1 = "Low Carb Diet";
            else if (30 <= bmi && bmi <= 35) diet_plan_1 = "Keto Diet";
            else if (25 <= bmi && bmi < 30) diet_plan_1 = "Mediterranean Diet";
            else if (fatPercentage > 30) diet_plan_1 = "Vegan Diet";
            else if (muscle_mass_pct > 40) diet_plan_1 = "High Protein Diet";
            else if (activityLevel == "Low (No activity)") diet_plan_1 = "Mind Diet";
            else if (activityLevel == "Moderate (3-5 workouts/week)") diet_plan_1 = "Intermittent Fasting";
            else if (bmi < 18.5) diet_plan_1 = "Zone Diet";
            else if (fatPercentage < 20) diet_plan_1 = "Nordic Diet";
            else if (minerals_mass > 3) diet_plan_1 = "DASH Diet";
            else if (weight % 2 == 0) diet_plan_1 = "Whole30 Diet";
            else diet_plan_1 = "Low FODMAP Diet";

            if (water_mass < 50) diet_plan_2 = "High Fiber Diet";
            else if (weight % 3 == 0) diet_plan_2 = "Balanced Diet";
            else if (protein_mass > 2) diet_plan_2 = "Calorie Deficit Diet";
            else if (fatPercentage > 35) diet_plan_2 = "Low Cholesterol Diet";
            else if (bmi < 18) diet_plan_2 = "Pescatarian Diet";
            else if (activityLevel == "High (Daily exercise)") diet_plan_2 = "Raw Food Diet";
            else if (minerals_mass < 2) diet_plan_2 = "Detox Diet";
            else if (age > 40) diet_plan_2 = "Anti-Inflammatory Diet";
            else diet_plan_2 = "Sustainable Diet";

            // Goal Logic
            let body_type = "Normal";
            if (bmi < 18.5) body_type = "Underweight";
            else if (bmi < 22 && muscle_mass_pct < 35) body_type = "Skinny";
            else if (bmi < 25 && fatPercentage > 25) body_type = "Skinny Fat";
            else if (bmi >= 30) body_type = "Obese";
            else if (muscle_mass_pct >= 40) body_type = "Athletic";
            else body_type = "Normal";

            const goalMap = {
                "Underweight": { key: "gGain", force: true },
                "Skinny": { key: "gMuscle" },
                "Skinny Fat": { key: "gRecomp" },
                "Obese": { key: "gLoss" },
                "Normal": { key: "gMaint" },
                "Athletic": { key: "gMaint" }
            };
            const goal = goalMap[body_type] || goalMap["Normal"];

            // --- UPDATE: Calculate Macros based on Diet 1 ---
            const finalMacros = calculateMacros(tdee, diet_plan_1);

            calculationData = {
                name, phone, gender, age, height, weight, bmi, body_type, 
                fatPercentage, fat_mass, muscle_mass, skeletal_muscle_mass, water_mass, minerals_mass, protein_mass,
                calcium, iron, magnesium, carb_mass,
                hr_max, fat_burning_zone_min, fat_burning_zone_max, ideal_weight, ideal_weight_range,
                daily_caloric_needs: tdee, bmr,
                vFat, metabolicAge,
                macros: finalMacros,
                goal, diet_plan_1, diet_plan_2
            };

            // Save to History
            saveToHistory(calculationData, name);

            // Render
            renderDashboard(calculationData);
            renderReportPreview(calculationData);
            renderChart(calculationData.muscle_mass, calculationData.fat_mass, calculationData.weight);
            goToScreen('results-page');
        }

        function renderDashboard(data) {
            const L = i18n[currentLang];
            document.getElementById('res-name-display').innerText = data.name;
            document.getElementById('res-goal-badge').innerText = L[data.goal.key];

            const wContainer = document.getElementById('warnings-container');
            wContainer.innerHTML = '';
            if(data.body_type==="Obese") {
                const div = document.createElement('div');
                div.className = 'warning-box';
                div.innerHTML = `<i class="fas fa-exclamation-triangle" style="color:var(--warning)"></i> <div>${L['wObese']}</div>`;
                wContainer.appendChild(div);
            }

            // Main Metrics
            document.getElementById('res-bmi').innerText = data.bmi.toFixed(1);
            document.getElementById('res-body-type').innerText = data.body_type.toUpperCase();
            document.getElementById('res-fat').innerText = data.fatPercentage.toFixed(1) + "%";
            document.getElementById('res-fat-mass').innerText = `${data.fat_mass.toFixed(1)} kg`;
            document.getElementById('res-muscle').innerText = `${data.muscle_mass.toFixed(1)} kg`;
            document.getElementById('res-sk-muscle').innerText = `${data.skeletal_muscle_mass.toFixed(1)} kg`;
            document.getElementById('res-calories').innerText = Math.round(data.daily_caloric_needs);
            document.getElementById('res-adj-cal').innerText = `Adj: ${Math.round(data.daily_caloric_needs)}`;

            // NEW Metrics
            document.getElementById('res-metabolic-age').innerText = data.metabolicAge;
            document.getElementById('res-vfat').innerText = data.vFat;

            // Detailed
            document.getElementById('res-water').innerText = `${data.water_mass.toFixed(1)} L`;
            document.getElementById('res-protein-mass').innerText = `${data.protein_mass.toFixed(1)} kg`;
            document.getElementById('res-minerals').innerText = `${data.minerals_mass.toFixed(2)} kg`;
            document.getElementById('res-hr-zone').innerText = `${Math.round(data.fat_burning_zone_min)}-${Math.round(data.fat_burning_zone_max)}`;
            document.getElementById('res-ideal-weight').innerText = `${data.ideal_weight.toFixed(1)} kg`;

            // NEW: Macros Display
            document.getElementById('macro-p').innerText = data.macros.protein;
            document.getElementById('macro-c').innerText = data.macros.carbs;
            document.getElementById('macro-f').innerText = data.macros.fats;

            // Diet Cards
            const dContainer = document.getElementById('diet-container');
            dContainer.innerHTML = '';
            [data.diet_plan_1, data.diet_plan_2].forEach((dietName, idx) => {
                const dietInfo = dietLibrary[dietName];
                const div = document.createElement('div');
                div.style.background = 'var(--bg-card)';
                div.style.padding = '20px';
                div.style.borderRadius = '12px';
                div.style.borderLeft = idx===0 ? '4px solid var(--primary)' : 'none';
                if(currentLang==='ar') div.style.borderRight = idx===0 ? '4px solid var(--primary)' : 'none';

                div.innerHTML = `
                    <h4 style="color:var(--primary); margin-bottom:5px">${dietName}</h4>
                    <p style="font-size:0.9rem; color:var(--text-gray)">${dietInfo[currentLang]}</p>
                `;
                dContainer.appendChild(div);
            });
        }

        function renderChart(m, f, w) {
            const ctx = document.getElementById('compositionChart').getContext('2d');
            if(chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: [currentLang==='en'?'Muscle':'عضلات', currentLang==='en'?'Fat':'دهون', currentLang==='en'?'Other':'أخرى'],
                    datasets: [{
                        data: [m.toFixed(1), f.toFixed(1), (w-m-f).toFixed(1)],
                        backgroundColor: ['#00d2ff', '#ff5252', '#2c3e50'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom', labels: { color: '#fff' } } },
                    cutout: '70%'
                }
            });
        }

        function renderReportPreview(data) {
            const L = i18n[currentLang];
            const container = document.getElementById('report-capture-area');
            if(currentLang==='ar') container.classList.add('rtl-report');
            else container.classList.remove('rtl-report');

            container.innerHTML = `
                <div class="report-header">
                    <div class="report-logo">INBODY BY ER1991</div>
                    <div style="color:#666; font-size:12px">Advanced Body Composition Analysis</div>
                </div>
                <div class="report-section-title">Personal Information</div>
                <div class="report-grid">
                    <div class="report-row"><span>Name:</span> <span class="report-val">${data.name}</span></div>
                    <div class="report-row"><span>Phone:</span> <span class="report-val">${data.phone || '-'}</span></div>
                    <div class="report-row"><span>Age:</span> <span class="report-val">${data.age} years</span></div>
                    <div class="report-row"><span>Gender:</span> <span class="report-val">${data.gender}</span></div>
                </div>
                <div class="report-section-title">Body Analysis</div>
                <div class="report-grid">
                    <div class="report-row"><span>Height:</span> <span class="report-val">${data.height} cm</span></div>
                    <div class="report-row"><span>Weight:</span> <span class="report-val">${data.weight} kg</span></div>
                    <div class="report-row"><span>BMI:</span> <span class="report-val">${data.bmi.toFixed(2)}</span></div>
                    <div class="report-row"><span>Body Type:</span> <span class="report-val" style="color:#006ba6">${data.body_type.toUpperCase()}</span></div>
                    <div class="report-row"><span>Body Fat %:</span> <span class="report-val">${data.fatPercentage.toFixed(2)}%</span></div>
                    <div class="report-row"><span>Fat Mass:</span> <span class="report-val">${data.fat_mass.toFixed(2)} kg</span></div>
                </div>
                <div class="report-section-title" style="background:#fff3cd; color:#856404">Advanced Estimates</div>
                <div class="report-grid">
                    <div class="report-row"><span>Metabolic Age:</span> <span class="report-val" style="color:#856404; font-weight:800">${data.metabolicAge}</span></div>
                    <div class="report-row"><span>Visceral Fat (Est):</span> <span class="report-val" style="color:#d32f2f; font-weight:800">${data.vFat}</span></div>
                </div>
                <div class="report-section-title">Muscle & Minerals</div>
                <div class="report-grid">
                    <div class="report-row"><span>Muscle Mass:</span> <span class="report-val">${data.muscle_mass.toFixed(2)} kg</span></div>
                    <div class="report-row"><span>Skeletal Muscle:</span> <span class="report-val">${data.skeletal_muscle_mass.toFixed(2)} kg</span></div>
                    <div class="report-row"><span>Protein Mass:</span> <span class="report-val">${data.protein_mass.toFixed(2)} kg</span></div>
                    <div class="report-row"><span>Water:</span> <span class="report-val">${data.water_mass.toFixed(2)} kg</span></div>
                    <div class="report-row"><span>Minerals:</span> <span class="report-val">${data.minerals_mass.toFixed(2)} kg</span></div>
                </div>
                <div class="report-section-title">Daily Macros (${data.diet_plan_1})</div>
                <div class="report-grid" style="grid-template-columns: 1fr 1fr 1fr; text-align:center;">
                    <div class="report-row" style="flex-direction:column; border:none;">
                        <small>Protein</small> <span class="report-val" style="font-size:1.2rem; color:#00e676">${data.macros.protein}g</span>
                    </div>
                    <div class="report-row" style="flex-direction:column; border:none;">
                        <small>Carbs</small> <span class="report-val" style="font-size:1.2rem; color:#ffb142">${data.macros.carbs}g</span>
                    </div>
                    <div class="report-row" style="flex-direction:column; border:none;">
                        <small>Fats</small> <span class="report-val" style="font-size:1.2rem; color:#ff5252">${data.macros.fats}g</span>
                    </div>
                </div>
                <div class="report-section-title">Detailed Components</div>
                <div class="report-full">
                    <div class="report-row"><span>Carbohydrates:</span> <span class="report-val">${data.carb_mass.toFixed(2)} g</span></div>
                    <div class="report-row"><span>Calcium:</span> <span class="report-val">${data.calcium.toFixed(2)} g</span></div>
                    <div class="report-row"><span>Iron:</span> <span class="report-val">${data.iron.toFixed(2)} g</span></div>
                    <div class="report-row"><span>Magnesium:</span> <span class="report-val">${data.magnesium.toFixed(2)} g</span></div>
                </div>
                <div class="report-section-title">Metabolism & Energy</div>
                <div class="report-full">
                    <div class="report-row"><span>BMR:</span> <span class="report-val">${data.bmr.toFixed(2)} kcal/day</span></div>
                    <div class="report-row"><span>Daily Calories:</span> <span class="report-val">${data.daily_caloric_needs.toFixed(2)} kcal</span></div>
                </div>
                <div class="report-section-title">Targets & Goals</div>
                <div class="report-grid">
                    <div class="report-row"><span>Ideal Weight:</span> <span class="report-val">${data.ideal_weight.toFixed(2)} kg</span></div>
                    <div class="report-row"><span>Ideal Range:</span> <span class="report-val">${data.ideal_weight_range[0].toFixed(2)} - ${data.ideal_weight_range[1].toFixed(2)} kg</span></div>
                    <div class="report-row"><span>HR Max:</span> <span class="report-val">${data.hr_max} bpm</span></div>
                    <div class="report-row"><span>Fat Burn Zone:</span> <span class="report-val">${data.fat_burning_zone_min.toFixed(2)} - ${data.fat_burning_zone_max.toFixed(2)} bpm</span></div>
                </div>
                <div style="background:#f0fdf4; padding:8px; border-radius:4px; margin-top:10px; text-align:center; color:#166534; font-weight:bold;">
                    ${L[data.goal.key]}
                </div>
                <div class="report-section-title">Recommended Nutrition</div>
                <div style="background:#f9f9f9; padding:10px; border-radius:4px;">
                    <div style="margin-bottom:10px; padding-bottom:10px; border-bottom:1px solid #eee">
                        <b style="color:#00d2ff">${data.diet_plan_1}</b><br>
                        <span style="font-size:12px; color:#555">${dietLibrary[data.diet_plan_1][currentLang]}</span>
                    </div>
                    <div style="margin-bottom:10px; padding-bottom:10px; border-bottom:1px solid #eee">
                        <b style="color:#00d2ff">${data.diet_plan_2}</b><br>
                        <span style="font-size:12px; color:#555">${dietLibrary[data.diet_plan_2][currentLang]}</span>
                    </div>
                </div>
                <div style="margin-top:30px; text-align:center; border-top:1px solid #eee; padding-top:10px; font-size:11px; color:#999;">
                    Generated by INBODY BY ER1991 App © 2026
                </div>
            `;
        }

        // --- NEW: PDF Download ---
        async function downloadPDF() {
            const btn = document.querySelector('button[onclick="downloadPDF()"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${currentLang==='en'?'Generating PDF...':'جاري إنشاء الـ PDF...'}`;
            btn.disabled = true;

            try {
                const { jsPDF } = window.jspdf;
                const element = document.getElementById("report-capture-area");
                
                // High scale for better quality
                const canvas = await html2canvas(element, { scale: 2, useCORS: true, backgroundColor: "#ffffff" });
                const imgData = canvas.toDataURL("image/png");
                
                const pdf = new jsPDF("p", "mm", "a4");
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const imgProps = pdf.getImageProperties(imgData);
                // Calculate height to fit width
                const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                
                pdf.addImage(imgData, "PNG", 0, 0, pdfWidth, pdfHeight);
                pdf.save(`InBody_Report_${new Date().getTime()}.pdf`);
                
                btn.innerHTML = originalText;
                btn.disabled = false;
            } catch(e) {
                console.error("PDF Error:", e);
                alert("Error generating PDF. Please try Image download.");
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        function downloadReport() {
            const btn = document.querySelector('.btn-primary'); // Main button
            const originalText = btn.innerHTML;
            btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${currentLang==='en'?'Generating...':'جاري الإنشاء...'}`;
            btn.disabled = true;

            setTimeout(() => {
                const element = document.getElementById("report-capture-area");
                html2canvas(element, { scale: 2, useCORS: true, backgroundColor: "#ffffff" }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = `InBody_ER1991_${calculationData.name}.png`;
                    link.href = canvas.toDataURL();
                    link.click();

                    // Attach Image to Page
                    const imgContainer = document.getElementById('generated-image-container');
                    imgContainer.innerHTML = ''; 
                    const img = document.createElement('img');
                    img.src = canvas.toDataURL();
                    const title = document.createElement('h4');
                    title.innerText = currentLang === 'en' ? 'Generated Report Preview:' : 'معاينة التقرير المولد:';
                    title.style.color = 'var(--primary)';
                    title.style.marginBottom = '10px';
                    imgContainer.appendChild(title);
                    imgContainer.appendChild(img);
                    imgContainer.classList.remove('hidden');

                    btn.innerHTML = originalText;
                    btn.disabled = false;
                });
            }, 500);
        }
    </script>
</body>
</html>
